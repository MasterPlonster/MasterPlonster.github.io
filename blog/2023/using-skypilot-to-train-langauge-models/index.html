<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Training Large Language Models with Skypilot | Eyal Fisher</title> <meta name="author" content="Eyal Fisher"> <meta name="description" content="a useful tool to help with hardware provisioing and environment setup for training large language models."> <meta name="keywords" content="eyal fisher, generative AI, genai, AI"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://www.eyalfisher.com/blog/2023/using-skypilot-to-train-langauge-models/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Eyal </span>Fisher</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/book/">book</a> </li> <li class="nav-item"> <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Training Large Language Models with Skypilot</h1> <p class="post-meta">August 4, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/skypilot"> <i class="fas fa-hashtag fa-sm"></i> skypilot</a>   <a href="/blog/tag/training"> <i class="fas fa-hashtag fa-sm"></i> training</a>   <a href="/blog/tag/llm"> <i class="fas fa-hashtag fa-sm"></i> llm</a>   <a href="/blog/tag/tips"> <i class="fas fa-hashtag fa-sm"></i> tips</a>     ·   <a href="/blog/category/llm"> <i class="fas fa-tag fa-sm"></i> llm</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="about-skypilot">About SkyPilot</h2> <p>If you ever tried to finetune a large language model, you probably know that provisioning and preparing the hardware and environment can be a pain. GPU availability is limited, and you need to make sure you have the right CUDA version, the right drivers, and the right libraries.</p> <p>I’ve been using <a href="https://skypilot.readthedocs.io/en/latest/" rel="external nofollow noopener" target="_blank">SkyPilot</a> for a while now, and it made a big difference in my life. Initially it was just a convinience tool for me to quickly search for a GCP zone with A100 availability, but I quickly discovered that relying on it forces me to be much more organized and disciplined in organizing my training runs.</p> <p>Technically speaking, SkyPilot is an abstraction of Ray + Cloud provider SDK + some niceities, including folder syncing, a task queue and managment of spot instances. It’s free, open source, and easy to use. So let’s get started.</p> <h2 id="first-steps">First Steps</h2> <p>First, you need to <a href="https://skypilot.readthedocs.io/en/latest/getting-started/installation.html" rel="external nofollow noopener" target="_blank">install SkyPilot</a> and configure the CLIs for your favourite cloud providers.</p> <p>In you are using AWS:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>skypilot
pip <span class="nb">install </span>skypilot[aws]

pip <span class="nb">install </span>boto3
aws configure
</code></pre></div></div> <p>You also need to make sure that you’ve got the relevant quota set up for your account. With GCP there’s some API activation you need to do, and with AWS you need to request a quota increase. The documentation explains how to do that.</p> <p>Next, it’s time to configure your project. You can do that by creating a <code class="language-plaintext highlighter-rouge">skypilot.yaml</code> file in your project directory. Here’s an example:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">resources</span><span class="pi">:</span>
  <span class="na">cloud</span><span class="pi">:</span> <span class="s">aws</span>
  <span class="na">accelerators</span><span class="pi">:</span> <span class="s">A100:4</span> <span class="c1"># Pick the kind and number of GPUs you want to use.</span>

<span class="c1"># Working directory (optional) containing the project codebase</span>
<span class="c1"># Its contents are synced to ~/sky_workdir/ on the cluster.</span>
<span class="na">workdir</span><span class="pi">:</span> <span class="s">.</span>

<span class="c1"># Invoked under the workdir (i.e., can use its files)</span>
<span class="c1"># This is where you set up your environment and install dependencies</span>
<span class="c1"># The machine will already have conda install so you can use that to set up your environment with the correct python version.</span>
<span class="na">setup</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">conda create -n skypilot python=3.10</span>
    <span class="s">conda activate skypilot</span>

    <span class="s">pip install -r requirements.txt</span>

<span class="c1"># This is the main action, where you run your job.</span>
<span class="c1"># Invoked under the workdir (i.e., can use its files).</span>
<span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">python train.py</span>
</code></pre></div></div> <p>Now creating a cluster and running the job is a simple as:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sky launch <span class="nt">-c</span> mycluster skypilot.yaml
</code></pre></div></div> <p>SkyPilot will also helpfully add the host to your ssh config, so you can easily ssh into it with <code class="language-plaintext highlighter-rouge">ssh mycluster</code>.</p> <p>To see your running clusters, it’s as simple as <code class="language-plaintext highlighter-rouge">sky status</code>, and you can terminate the cluster with <code class="language-plaintext highlighter-rouge">sky down mycluster</code>.</p> <h2 id="autostop">Autostop</h2> <p>As we all know, forgetting your training machine on can be expensive. SkyPilot has a nice feature called <code class="language-plaintext highlighter-rouge">autostop</code> that will automatically stop the machine after a certain amount of idle time. You can launch a task with autostop using the flag <code class="language-plaintext highlighter-rouge">-i</code> like this:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sky launch <span class="nt">-d</span> <span class="nt">-c</span> mycluster cluster.yaml <span class="nt">-i</span> 10 <span class="nt">--down</span>
</code></pre></div></div> <h2 id="saving-logs-and-artefacts">Saving Logs and Artefacts</h2> <p>Terminating a cluster when your task is done obviously means that everything stored on the machine is lost. The way I like to work is to save the Logs to Weights and Biases, and save the model checkpoints to either a bucket or HuggingFace Hub.</p> <p>If using a HuggingFace trainer this is as simple as addign <code class="language-plaintext highlighter-rouge">report_to=wand</code> and <code class="language-plaintext highlighter-rouge">push_to_hub=True</code> to the <code class="language-plaintext highlighter-rouge">TrainingArguments</code>. You do need to make sure you are logged in to both, or pass the relevant authentication tokens.</p> <p>While SkyPilot provides can use an env section in the skypilot.yaml pass environment variables, I like to store my template in github, which is not a safe place for secrets. Instead, I use a <code class="language-plaintext highlighter-rouge">.env</code> file in the project directory, which is synced by SkyPilot directly to the cluster, and then I can use it to set the environment variables like this:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">resources</span><span class="pi">:</span>
  <span class="na">cloud</span><span class="pi">:</span> <span class="s">aws</span>
  <span class="na">accelerators</span><span class="pi">:</span> <span class="s">A100:4</span> <span class="c1"># Pick the kind and number of GPUs you want to use.</span>

<span class="c1"># Working directory (optional) containing the project codebase</span>
<span class="c1"># Its contents are synced to ~/sky_workdir/ on the cluster.</span>
<span class="na">workdir</span><span class="pi">:</span> <span class="s">.</span>

<span class="c1"># Invoked under the workdir (i.e., can use its files)</span>
<span class="c1"># This is where you set up your environment and install dependencies</span>
<span class="c1"># The machine will already have conda install so you can use that to set up your environment with the correct python version.</span>
<span class="na">setup</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">conda create -n skypilot python=3.10</span>
    <span class="s">conda activate skypilot</span>

    <span class="s">pip install -r requirements.txt</span>

    <span class="s">export $(grep -v '^#' .env | xargs)</span>
    <span class="s">wandb login $WANB_TOKEN</span>

<span class="c1"># This is the main action, where you run your job.</span>
<span class="c1"># Invoked under the workdir (i.e., can use its files).</span>
<span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">python train.py</span>
</code></pre></div></div> <h2 id="using-the-job-queue">Using The Job Queue</h2> <p>The job queue comes without any additional configuration, and is a great way to manage multiple jobs. After you spin up your cluster you can just send additional jobs with:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sky <span class="nb">exec </span>mycluster task.yaml <span class="nt">-d</span>
</code></pre></div></div> <p>Where <code class="language-plaintext highlighter-rouge">task.yaml</code> is a file with the same structure as <code class="language-plaintext highlighter-rouge">skypilot.yaml</code> containing a task configuration.</p> </div> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"alshedivat/al-folio","data-repo-id":"MDEwOlJlcG9zaXRvcnk2MDAyNDM2NQ==","data-category":"Comments","data-category-id":"DIC_kwDOA5PmLc4CTBt6","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,a])=>giscusScript.setAttribute(t,a)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Eyal Fisher. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>